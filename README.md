# GridLAB-D Digital Twin API

FastAPI service for building and running household digital-twin scenarios with GridLAB-D. The service stores household configurations, renders GLM files via Jinja, orchestrates synthetic appliance profiles, executes GridLAB-D (optionally), and ingests simulation outputs into Postgres for partner-friendly querying.

## Features

- REST endpoints to create, patch, and version household configs
- Scenario builder that generates appliance CSVs and GLM files
- Partner-focused `/partner/simulations` endpoint that hides internal complexity
- Automatic result ingestion into `results` and `result_timeseries` tables
- Unit conversion utilities (SI/metric ⇄ GridLAB-D units)
- Docker Compose setup for local Postgres config/results databases

## Prerequisites

- Python 3.10+
- GridLAB-D installed and accessible on `PATH`
- Docker + Docker Compose (for running the databases)

## Quick Start

```bash
# clone repo then
python -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# start Postgres containers
docker compose -f docker-compose.databases.yml up -d

# initialize databases (if running first time)
psql -h localhost -p 5432 -U postgres -d configs_db -f init_db_configs.sql
psql -h localhost -p 5433 -U postgres -d results_db -f init_db_results.sql

# run API
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

Verify the service:

```bash
curl http://localhost:8000/health
```

## Workflow Overview

1. **Create/maintain configs** using `/configs` endpoints (supports unit auto-detection).
2. **Generate a scenario** via `/simulations` or partner `/partner/simulations`.
3. **Execute the scenario** using `/simulations/{scenario_id}/execute` (or upload results manually via `/results`).
4. **Query outputs** using `/results`, `/results/{id}/series`, or `/scenarios/{scenario_id}/results`.

## Key Endpoints

| Endpoint | Description |
| --- | --- |
| `POST /configs` | Create household configuration (auto converts to GridLAB-D units) |
| `PATCH /configs/{id}` | Deep-merge update to existing config |
| `POST /simulations` | Build a scenario from a config (creates GLM + appliance CSVs) |
| `POST /simulations/{scenario_id}/execute` | Run GridLAB-D for a scenario; ingests CSV automatically |
| `POST /partner/simulations` | Single-call partner workflow: ensures config, makes scenario, optionally runs + returns results |
| `GET /results/{result_id}/series` | Retrieve stored time-series data (in GridLAB-D or partner units) as structured JSON |
| `GET /results/{result_id}/csv` | Get raw CSV content exactly as generated by GridLAB-D (text/csv response) |
| `GET /download/results/{result_id}` | Download result file as attachment |
| `GET /scenarios/{scenario_id}/results` | List results linked to a scenario |

## Usage Examples

### 1. Create a Config

```bash
curl -X POST http://localhost:8000/configs \
  -H "Content-Type: application/json" \
  -d '{
        "name": "test_house",
        "config": {
          "floor_area": 180,
          "cooling_setpoint": 24,
          "heating_setpoint": 20,
          "default_simulation": {
            "output_properties": ["house:total_load", "house:air_temperature"],
            "recording_interval": 60
          },
          "appliance_templates": {
            "washing_machine": { "nominal_power": 2.2, "pattern_dir": "washing_machine_patterns" }
          }
        }
      }'
```

### 2. Partner-Friendly Simulation

```bash
curl -X POST http://localhost:8000/partner/simulations \
  -H "Content-Type: application/json" \
  -d '{
        "partner_request_id": "demo-001",
        "household": { "name": "test_house" },
        "scenario": {
          "start_time": "2025-02-01 00:00:00",
          "stop_time": "2025-02-02 00:00:00",
          "output_properties": ["house:total_load"]
        },
        "execution": {
          "run_immediately": true,
          "return_results": true,
          "result_format": "partner"
        }
      }'
```

Response includes `scenario_id`, `result_id`, and `results.series` (temperature converted to °C, energy to kWh when `result_format=partner`).

### 3. Execute Existing Scenario

```bash
curl -X POST http://localhost:8000/simulations/<scenario_id>/execute
```

### 4. Retrieve Time-Series Data

```bash
curl "http://localhost:8000/results/<result_id>/series?properties=house:total_load&fmt=gridlabd"
```

### 5. Get Raw CSV Content

**Option A: Download as file**
```bash
curl -O http://localhost:8000/download/results/<result_id>
```

**Option B: Get CSV as text response** (new)
```bash
curl http://localhost:8000/results/<result_id>/csv
```

Returns the exact CSV content as generated by GridLAB-D, including all header comments. Useful for programmatic access without file download.

## Climate CSV Integration

Scenarios automatically pull the correct TMY/CSV weather data into each scenario folder:

1. Place pilot weather files under `data/tmy/` (default location) using the expected names:
   - `murcia.csv`
   - `aspra_spitia.csv`
   - `zagreb.csv`
2. Add a `pilot` (or `climate_profile`) field to your household config or overrides. The value must match one of the profile keys above (case-insensitive). Example:

```json
{
  "name": "house_athens_complete_example",
  "config": {
    "pilot": "aspra_spitia",
    "...": "..."
  }
}
```

3. When `/simulations` (or `/partner/simulations`) runs, the service copies the matching CSV into the scenario directory and renders the GLM with:

```glm
object csv_reader {
    name climate_reader_xxxx;
    filename "aspra_spitia.csv";
}

object climate {
    tmyfile "aspra_spitia.csv";
    reader climate_reader_xxxx;
};
```

4. To use a custom CSV outside the default pool, set `config["climate"]["csv"]` (absolute path or file name under `data/tmy/`).

## Result Storage Model

- `results` table stores uploaded CSV files + metadata (`scenario_id`, `config_id`, etc.).
- `result_timeseries` stores normalized rows per property/timestamp. Created via `_ingest_result_timeseries` when simulations finish or CSVs are uploaded manually.
- `/results/{id}/series` queries `result_timeseries`, aggregates by property, and optionally converts units to partner format just-in-time.

## Development Notes

- Helper modules live under `utils/`: `db_helpers`, `parsing_helpers`, `partner_helpers`, `result_helpers`, etc.
- GLM template (`GLM_TEMPLATE` in `main.py`) is rendered with Jinja using the merged configuration and generated CSV references.
- Appliance pattern CSVs are generated through `utils.genererate_consumption_utils.generate_appliance_csv`.
- Weather files live under `data/tmy/` (override with `TMY_BASE_DIR` env var). The service copies the matched CSV into each scenario folder automatically.

## Troubleshooting

- Ensure GridLAB-D is on the PATH; otherwise, set absolute path in `execute_simulation`.
- Missing `typical_light_yearly.glm`: copy this schedule file into each scenario directory or change the template include path to an absolute location.
- `result_timeseries` missing errors: run `init_db_results.sql` against the results database to create the new table/indexes.
- Property names in `/results/{id}/series` must match the CSV header exactly (e.g., `house:total_load`, not `house: total_load`).

## License

Internal project – add licensing details if needed.


